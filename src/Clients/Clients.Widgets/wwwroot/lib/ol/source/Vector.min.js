/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/ol@8.1.0/source/Vector.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import Collection from"../Collection.js";import CollectionEventType from"../CollectionEventType.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import ObjectEventType from"../ObjectEventType.js";import RBush from"../structs/RBush.js";import Source from"./Source.js";import VectorEventType from"./VectorEventType.js";import{TRUE,VOID}from"../functions.js";import{all as allStrategy}from"../loadingstrategy.js";import{assert}from"../asserts.js";import{containsExtent,equals,wrapAndSliceX}from"../extent.js";import{extend}from"../array.js";import{getUid}from"../util.js";import{isEmpty}from"../obj.js";import{listen,unlistenByKey}from"../events.js";import{xhr}from"../featureloader.js";export class VectorSourceEvent extends Event{constructor(e,t,r){super(e),this.feature=t,this.features=r}}class VectorSource extends Source{constructor(e){super({attributions:(e=e||{}).attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:void 0===e.wrapX||e.wrapX}),this.on,this.once,this.un,this.loader_=VOID,this.format_=e.format,this.overlaps_=void 0===e.overlaps||e.overlaps,this.url_=e.url,void 0!==e.loader?this.loader_=e.loader:void 0!==this.url_&&(assert(this.format_,"`format` must be set when `url` is set"),this.loader_=xhr(this.url_,this.format_)),this.strategy_=void 0!==e.strategy?e.strategy:allStrategy;const t=void 0===e.useSpatialIndex||e.useSpatialIndex;let r,s;this.featuresRtree_=t?new RBush:null,this.loadedExtentsRtree_=new RBush,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null,Array.isArray(e.features)?s=e.features:e.features&&(r=e.features,s=r.getArray()),t||void 0!==r||(r=new Collection(s)),void 0!==s&&this.addFeaturesInternal(s),void 0!==r&&this.bindFeaturesCollection_(r)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=getUid(e);if(!this.addToIndex_(t,e))return void(this.featuresCollection_&&this.featuresCollection_.remove(e));this.setupChangeEvents_(t,e);const r=e.getGeometry();if(r){const t=r.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(t,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,e))}setupChangeEvents_(e,t){this.featureChangeKeys_[e]=[listen(t,EventType.CHANGE,this.handleFeatureChange_,this),listen(t,ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_,this)]}addToIndex_(e,t){let r=!0;const s=t.getId();return void 0!==s&&(s.toString()in this.idIndex_?r=!1:this.idIndex_[s.toString()]=t),r&&(assert(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),r}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],r=[],s=[];for(let t=0,s=e.length;t<s;t++){const s=e[t],n=getUid(s);this.addToIndex_(n,s)&&r.push(s)}for(let e=0,n=r.length;e<n;e++){const n=r[e],i=getUid(n);this.setupChangeEvents_(i,n);const o=n.getGeometry();if(o){const e=o.getExtent();t.push(e),s.push(n)}else this.nullGeometryFeatures_[i]=n}if(this.featuresRtree_&&this.featuresRtree_.load(t,s),this.hasListener(VectorEventType.ADDFEATURE))for(let e=0,t=r.length;e<t;e++)this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,r[e]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(VectorEventType.ADDFEATURE,(function(r){t||(t=!0,e.push(r.feature),t=!1)})),this.addEventListener(VectorEventType.REMOVEFEATURE,(function(r){t||(t=!0,e.remove(r.feature),t=!1)})),e.addEventListener(CollectionEventType.ADD,(e=>{t||(t=!0,this.addFeature(e.element),t=!1)})),e.addEventListener(CollectionEventType.REMOVE,(e=>{t||(t=!0,this.removeFeature(e.element),t=!1)})),this.featuresCollection_=e}clear(e){if(e){for(const e in this.featureChangeKeys_){this.featureChangeKeys_[e].forEach(unlistenByKey)}this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){const e=e=>{this.removeFeatureInternal(e)};this.featuresRtree_.forEach(e);for(const e in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[e])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new VectorSourceEvent(VectorEventType.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const r=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(r,(function(r){if(r.getGeometry().intersectsCoordinate(e))return t(r)}))}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,(function(r){if(r.getGeometry().intersectsExtent(e)){const e=t(r);if(e)return e}}))}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),isEmpty(this.nullGeometryFeatures_)||extend(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,(function(e){t.push(e)})),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const r=wrapAndSliceX(e,t);return[].concat(...r.map((e=>this.featuresRtree_.getInExtent(e))))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){const r=e[0],s=e[1];let n=null;const i=[NaN,NaN];let o=1/0;const a=[-1/0,-1/0,1/0,1/0];return t=t||TRUE,this.featuresRtree_.forEachInExtent(a,(function(e){if(t(e)){const t=e.getGeometry(),u=o;if(o=t.closestPointXY(r,s,i,o),o<u){n=e;const t=Math.sqrt(o);a[0]=r-t,a[1]=s-t,a[2]=r+t,a[3]=s+t}}})),n}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){const t=this.idIndex_[e.toString()];return void 0!==t?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return void 0!==t?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,r=getUid(t),s=t.getGeometry();if(s){const e=s.getExtent();r in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[r],this.featuresRtree_&&this.featuresRtree_.insert(e,t)):this.featuresRtree_&&this.featuresRtree_.update(e,t)}else r in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[r]=t);const n=t.getId();if(void 0!==n){const e=n.toString();this.idIndex_[e]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[e]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[r]=t;this.changed(),this.dispatchEvent(new VectorSourceEvent(VectorEventType.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return void 0!==t?t in this.idIndex_:getUid(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&isEmpty(this.nullGeometryFeatures_):!this.featuresCollection_||0===this.featuresCollection_.getLength()}loadFeatures(e,t,r){const s=this.loadedExtentsRtree_,n=this.strategy_(e,t,r);for(let e=0,i=n.length;e<i;++e){const i=n[e];s.forEachInExtent(i,(function(e){return containsExtent(e.extent,i)}))||(++this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADSTART)),this.loader_.call(this,i,t,r,(e=>{--this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADEND,void 0,e))}),(()=>{--this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADERROR))})),s.insert(i,{extent:i.slice()}))}this.loading=!(this.loader_.length<4)&&this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_;let r;t.forEachInExtent(e,(function(t){if(equals(t.extent,e))return r=t,!0})),r&&t.remove(r)}removeFeature(e){if(!e)return;const t=getUid(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e);this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=getUid(e),r=this.featureChangeKeys_[t];if(!r)return;r.forEach(unlistenByKey),delete this.featureChangeKeys_[t];const s=e.getId();return void 0!==s&&delete this.idIndex_[s.toString()],delete this.uidIndex_[t],this.dispatchEvent(new VectorSourceEvent(VectorEventType.REMOVEFEATURE,e)),e}removeFromIdIndex_(e){let t=!1;for(const r in this.idIndex_)if(this.idIndex_[r]===e){delete this.idIndex_[r],t=!0;break}return t}setLoader(e){this.loader_=e}setUrl(e){assert(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(xhr(e,this.format_))}}export default VectorSource;
//# sourceMappingURL=/sm/931e2e2744a2eae69630b4eb83cccc36c2c278f93e47345ca6881e8233395926.map