/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/ol@8.1.0/source/WMTS.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import TileImage from"./TileImage.js";import{appendParams}from"../uri.js";import{containsExtent}from"../extent.js";import{createFromCapabilitiesMatrixSet}from"../tilegrid/WMTS.js";import{createFromTileUrlFunctions,expandUrl}from"../tileurlfunction.js";import{equivalent,get as getProjection,transformExtent}from"../proj.js";class WMTS extends TileImage{constructor(t){const e=void 0!==t.requestEncoding?t.requestEncoding:"KVP",i=t.tileGrid;let n=t.urls;void 0===n&&void 0!==t.url&&(n=expandUrl(t.url)),super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:t.tileClass,tileGrid:i,tileLoadFunction:t.tileLoadFunction,tilePixelRatio:t.tilePixelRatio,urls:n,wrapX:void 0!==t.wrapX&&t.wrapX,transition:t.transition,zDirection:t.zDirection}),this.version_=void 0!==t.version?t.version:"1.0.0",this.format_=void 0!==t.format?t.format:"image/jpeg",this.dimensions_=void 0!==t.dimensions?t.dimensions:{},this.layer_=t.layer,this.matrixSet_=t.matrixSet,this.style_=t.style,this.requestEncoding_=e,this.setKey(this.getKeyForDimensions_()),n&&n.length>0&&(this.tileUrlFunction=createFromTileUrlFunctions(n.map(this.createFromWMTSTemplate.bind(this))))}setUrls(t){this.urls=t;const e=t.join("\n");this.setTileUrlFunction(createFromTileUrlFunctions(t.map(this.createFromWMTSTemplate.bind(this))),e)}getDimensions(){return this.dimensions_}getFormat(){return this.format_}getLayer(){return this.layer_}getMatrixSet(){return this.matrixSet_}getRequestEncoding(){return this.requestEncoding_}getStyle(){return this.style_}getVersion(){return this.version_}getKeyForDimensions_(){const t=this.urls?this.urls.slice(0):[];for(const e in this.dimensions_)t.push(e+"-"+this.dimensions_[e]);return t.join("/")}updateDimensions(t){Object.assign(this.dimensions_,t),this.setKey(this.getKeyForDimensions_())}createFromWMTSTemplate(t){const e=this.requestEncoding_,i={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};"KVP"==e&&Object.assign(i,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),t="KVP"==e?appendParams(t,i):t.replace(/\{(\w+?)\}/g,(function(t,e){return e.toLowerCase()in i?i[e.toLowerCase()]:t}));const n=this.tileGrid,r=this.dimensions_;return function(i,o,s){if(!i)return;const a={TileMatrix:n.getMatrixId(i[0]),TileCol:i[1],TileRow:i[2]};Object.assign(a,r);let l=t;return l="KVP"==e?appendParams(l,a):l.replace(/\{(\w+?)\}/g,(function(t,e){return a[e]})),l}}}export default WMTS;export function optionsFromCapabilities(t,e){const i=t.Contents.Layer.find((function(t){return t.Identifier==e.layer}));if(!i)return null;const n=t.Contents.TileMatrixSet;let r;r=i.TileMatrixSetLink.length>1?"projection"in e?i.TileMatrixSetLink.findIndex((function(t){const i=n.find((function(e){return e.Identifier==t.TileMatrixSet})).SupportedCRS,r=getProjection(i),o=getProjection(e.projection);return r&&o?equivalent(r,o):i==e.projection})):i.TileMatrixSetLink.findIndex((function(t){return t.TileMatrixSet==e.matrixSet})):0,r<0&&(r=0);const o=i.TileMatrixSetLink[r].TileMatrixSet,s=i.TileMatrixSetLink[r].TileMatrixSetLimits;let a=i.Format[0];"format"in e&&(a=e.format),r=i.Style.findIndex((function(t){return"style"in e?t.Title==e.style:t.isDefault})),r<0&&(r=0);const l=i.Style[r].Identifier,c={};"Dimension"in i&&i.Dimension.forEach((function(t,e,i){const n=t.Identifier;let r=t.Default;void 0===r&&(r=t.Value[0]),c[n]=r}));const u=t.Contents.TileMatrixSet.find((function(t){return t.Identifier==o}));let d;const m=u.SupportedCRS;if(m&&(d=getProjection(m)),"projection"in e){const t=getProjection(e.projection);t&&(d&&!equivalent(t,d)||(d=t))}let f=!1;const p="ne"==d.getAxisOrientation().substr(0,2);let h=u.TileMatrix[0],T={MinTileCol:0,MinTileRow:0,MaxTileCol:h.MatrixWidth-1,MaxTileRow:h.MatrixHeight-1};if(s){T=s[s.length-1];const t=u.TileMatrix.find((t=>t.Identifier===T.TileMatrix||u.Identifier+":"+t.Identifier===T.TileMatrix));t&&(h=t)}const g=28e-5*h.ScaleDenominator/d.getMetersPerUnit(),x=p?[h.TopLeftCorner[1],h.TopLeftCorner[0]]:h.TopLeftCorner,S=h.TileWidth*g,M=h.TileHeight*g;let j=u.BoundingBox;j&&p&&(j=[j[1],j[0],j[3],j[2]]);let y=[x[0]+S*T.MinTileCol,x[1]-M*(1+T.MaxTileRow),x[0]+S*(1+T.MaxTileCol),x[1]-M*T.MinTileRow];if(void 0!==j&&!containsExtent(j,y)){const t=i.WGS84BoundingBox,e=getProjection("EPSG:4326").getExtent();if(y=j,t)f=t[0]===e[0]&&t[2]===e[2];else{const t=transformExtent(j,u.SupportedCRS,"EPSG:4326");f=t[0]-1e-10<=e[0]&&t[2]+1e-10>=e[2]}}const _=createFromCapabilitiesMatrixSet(u,y,s),C=[];let P=e.requestEncoding;if(P=void 0!==P?P:"","OperationsMetadata"in t&&"GetTile"in t.OperationsMetadata){const e=t.OperationsMetadata.GetTile.DCP.HTTP.Get;for(let t=0,i=e.length;t<i;++t)if(e[t].Constraint){const i=e[t].Constraint.find((function(t){return"GetEncoding"==t.name})).AllowedValues.Value;if(""===P&&(P=i[0]),"KVP"!==P)break;i.includes("KVP")&&C.push(e[t].href)}else e[t].href&&(P="KVP",C.push(e[t].href))}return 0===C.length&&(P="REST",i.ResourceURL.forEach((function(t){"tile"===t.resourceType&&(a=t.format,C.push(t.template))}))),{urls:C,layer:e.layer,matrixSet:o,format:a,projection:d,requestEncoding:P,tileGrid:_,style:l,dimensions:c,wrapX:f,crossOrigin:e.crossOrigin}}
//# sourceMappingURL=/sm/96da29f7f60ee698923c936a48de0f6da01a5abc1a5e476dbd0303881d7d9122.map