/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/ol@8.1.0/renderer/canvas/VectorLayer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import CanvasLayerRenderer,{canvasPool}from"./Layer.js";import ExecutorGroup from"../../render/canvas/ExecutorGroup.js";import RenderEventType from"../../render/EventType.js";import ViewHint from"../../ViewHint.js";import{HIT_DETECT_RESOLUTION,createHitDetectionImageData,hitDetect}from"../../render/canvas/hitdetect.js";import{apply,makeInverse,makeScale,toString as transformToString}from"../../transform.js";import{buffer,containsExtent,createEmpty,getWidth,intersects as intersectsExtent,wrapX as wrapExtentX}from"../../extent.js";import{createCanvasContext2D,releaseCanvas}from"../../dom.js";import{defaultOrder as defaultRenderOrder,getTolerance as getRenderTolerance,getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{equals}from"../../array.js";import{fromUserExtent,getTransformFromProjections,getUserProjection,toUserExtent,toUserResolution}from"../../proj.js";import{getUid}from"../../util.js";import{wrapX as wrapCoordinateX}from"../../coordinate.js";class CanvasVectorLayerRenderer extends CanvasLayerRenderer{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=createEmpty(),this.wrappedRenderedExtent_=createEmpty(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.declutterExecutorGroup=null,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(e,t,r){const n=t.extent,i=t.viewState,o=i.center,s=i.resolution,a=i.projection,d=i.rotation,h=a.getExtent(),c=this.getLayer().getSource(),l=t.pixelRatio,u=t.viewHints,p=!(u[ViewHint.ANIMATING]||u[ViewHint.INTERACTING]),g=this.compositionContext_,m=Math.round(t.size[0]*l),_=Math.round(t.size[1]*l),x=c.getWrapX()&&a.canWrapX(),f=x?getWidth(h):null,E=x?Math.ceil((n[2]-h[2])/f)+1:1;let R=x?Math.floor((n[0]-h[0])/f):0;do{const t=this.getRenderTransform(o,s,d,l,m,_,R*f);e.execute(g,1,t,d,p,void 0,r)}while(++R<E)}setupCompositionContext_(){if(1!==this.opacity_){const e=createCanvasContext2D(this.context.canvas.width,this.context.canvas.height,canvasPool);this.compositionContext_=e}else this.compositionContext_=this.context}releaseCompositionContext_(){if(1!==this.opacity_){const e=this.context.globalAlpha;this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=e,releaseCanvas(this.compositionContext_),canvasPool.push(this.compositionContext_.canvas),this.compositionContext_=null}}renderDeclutter(e){this.declutterExecutorGroup&&(this.setupCompositionContext_(),this.renderWorlds(this.declutterExecutorGroup,e,e.declutterTree),this.releaseCompositionContext_())}renderFrame(e,t){const r=e.pixelRatio,n=e.layerStatesArray[e.layerIndex];makeScale(this.pixelTransform,1/r,1/r),makeInverse(this.inversePixelTransform,this.pixelTransform);const i=transformToString(this.pixelTransform);this.useContainer(t,i,this.getBackground(e));const o=this.context,s=o.canvas,a=this.replayGroup_,d=this.declutterExecutorGroup;let h=a&&!a.isEmpty()||d&&!d.isEmpty();if(!h){if(!(this.getLayer().hasListener(RenderEventType.PRERENDER)||this.getLayer().hasListener(RenderEventType.POSTRENDER)))return null}const c=Math.round(e.size[0]*r),l=Math.round(e.size[1]*r);s.width!=c||s.height!=l?(s.width=c,s.height=l,s.style.transform!==i&&(s.style.transform=i)):this.containerReused||o.clearRect(0,0,c,l),this.preRender(o,e);const u=e.viewState,p=u.projection;this.opacity_=n.opacity,this.setupCompositionContext_();let g=!1;if(h&&n.extent&&this.clipping){const t=fromUserExtent(n.extent,p);h=intersectsExtent(t,e.extent),g=h&&!containsExtent(t,e.extent),g&&this.clipUnrotated(this.compositionContext_,e,t)}return h&&this.renderWorlds(a,e),g&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(o,e),this.renderedRotation_!==u.rotation&&(this.renderedRotation_=u.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(e){return new Promise((t=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const e=[this.context.canvas.width,this.context.canvas.height];apply(this.pixelTransform,e);const t=this.renderedCenter_,r=this.renderedResolution_,n=this.renderedRotation_,i=this.renderedProjection_,o=this.wrappedRenderedExtent_,s=this.getLayer(),a=[],d=e[0]*HIT_DETECT_RESOLUTION,h=e[1]*HIT_DETECT_RESOLUTION;a.push(this.getRenderTransform(t,r,n,HIT_DETECT_RESOLUTION,d,h,0).slice());const c=s.getSource(),l=i.getExtent();if(c.getWrapX()&&i.canWrapX()&&!containsExtent(l,o)){let e=o[0];const i=getWidth(l);let s,c=0;for(;e<l[0];)--c,s=i*c,a.push(this.getRenderTransform(t,r,n,HIT_DETECT_RESOLUTION,d,h,s).slice()),e+=i;for(c=0,e=o[2];e>l[2];)++c,s=i*c,a.push(this.getRenderTransform(t,r,n,HIT_DETECT_RESOLUTION,d,h,s).slice()),e-=i}this.hitDetectionImageData_=createHitDetectionImageData(e,a,this.renderedFeatures_,s.getStyleFunction(),o,r,n)}t(hitDetect(e,this.renderedFeatures_,this.hitDetectionImageData_))}))}forEachFeatureAtCoordinate(e,t,r,n,i){if(!this.replayGroup_)return;const o=t.viewState.resolution,s=t.viewState.rotation,a=this.getLayer(),d={},h=function(e,t,r){const o=getUid(e),s=d[o];if(s){if(!0!==s&&r<s.distanceSq){if(0===r)return d[o]=!0,i.splice(i.lastIndexOf(s),1),n(e,a,t);s.geometry=t,s.distanceSq=r}}else{if(0===r)return d[o]=!0,n(e,a,t);i.push(d[o]={feature:e,layer:a,geometry:t,distanceSq:r,callback:n})}};let c;const l=[this.replayGroup_];return this.declutterExecutorGroup&&l.push(this.declutterExecutorGroup),l.some((n=>c=n.forEachFeatureAtCoordinate(e,o,s,r,h,n===this.declutterExecutorGroup&&t.declutterTree?t.declutterTree.all().map((e=>e.value)):null))),c}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const t=this.getLayer(),r=t.getSource();if(!r)return!1;const n=e.viewHints[ViewHint.ANIMATING],i=e.viewHints[ViewHint.INTERACTING],o=t.getUpdateWhileAnimating(),s=t.getUpdateWhileInteracting();if(this.ready&&!o&&n||!s&&i)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const a=e.extent,d=e.viewState,h=d.projection,c=d.resolution,l=e.pixelRatio,u=t.getRevision(),p=t.getRenderBuffer();let g=t.getRenderOrder();void 0===g&&(g=defaultRenderOrder);const m=d.center.slice(),_=buffer(a,p*c),x=_.slice(),f=[_.slice()],E=h.getExtent();if(r.getWrapX()&&h.canWrapX()&&!containsExtent(E,e.extent)){const e=getWidth(E),t=Math.max(getWidth(_)/2,e);_[0]=E[0]-t,_[2]=E[2]+t,wrapCoordinateX(m,h);const r=wrapExtentX(f[0],h);r[0]<E[0]&&r[2]<E[2]?f.push([r[0]+e,r[1],r[2]+e,r[3]]):r[0]>E[0]&&r[2]>E[2]&&f.push([r[0]-e,r[1],r[2]-e,r[3]])}if(this.ready&&this.renderedResolution_==c&&this.renderedRevision_==u&&this.renderedRenderOrder_==g&&containsExtent(this.wrappedRenderedExtent_,_))return equals(this.renderedExtent_,x)||(this.hitDetectionImageData_=null,this.renderedExtent_=x),this.renderedCenter_=m,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const R=new CanvasBuilderGroup(getRenderTolerance(c,l),_,c,l);let y;this.getLayer().getDeclutter()&&(y=new CanvasBuilderGroup(getRenderTolerance(c,l),_,c,l));const C=getUserProjection();let T;if(C){for(let e=0,t=f.length;e<t;++e){const t=f[e],n=toUserExtent(t,h);r.loadFeatures(n,toUserResolution(c,h),C)}T=getTransformFromProjections(C,h)}else for(let e=0,t=f.length;e<t;++e)r.loadFeatures(f[e],c,h);const v=getSquaredRenderTolerance(c,l);let I=!0;const w=e=>{let r;const n=e.getStyleFunction()||t.getStyleFunction();if(n&&(r=n(e,c)),r){const t=this.renderFeature(e,v,r,R,T,y);I=I&&!t}},S=toUserExtent(_,h),D=r.getFeaturesInExtent(S);g&&D.sort(g);for(let e=0,t=D.length;e<t;++e)w(D[e]);this.renderedFeatures_=D,this.ready=I;const G=R.finish(),O=new ExecutorGroup(_,c,l,r.getOverlaps(),G,t.getRenderBuffer());return y&&(this.declutterExecutorGroup=new ExecutorGroup(_,c,l,r.getOverlaps(),y.finish(),t.getRenderBuffer())),this.renderedResolution_=c,this.renderedRevision_=u,this.renderedRenderOrder_=g,this.renderedExtent_=x,this.wrappedRenderedExtent_=_,this.renderedCenter_=m,this.renderedProjection_=h,this.replayGroup_=O,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,r,n,i,o){if(!r)return!1;let s=!1;if(Array.isArray(r))for(let a=0,d=r.length;a<d;++a)s=renderFeature(n,e,r[a],t,this.boundHandleStyleImageChange_,i,o)||s;else s=renderFeature(n,e,r,t,this.boundHandleStyleImageChange_,i,o);return s}}export default CanvasVectorLayerRenderer;
//# sourceMappingURL=/sm/eedc67a9c54c03975a1f3afe891f5143f0101a50df28f8a643c99b820d110138.map